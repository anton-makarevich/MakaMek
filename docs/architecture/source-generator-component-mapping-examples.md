# Component Mapping Source Generator - Code Examples

This document provides detailed code examples for the proposed source generator implementation.

## Table of Contents
1. [Component Class Patterns](#component-class-patterns)
2. [Generated Code Example](#generated-code-example)
3. [Modified Provider Class](#modified-provider-class)
4. [Developer Workflow](#developer-workflow)
5. [Generator Algorithm](#generator-algorithm)

## Component Class Patterns

All component classes follow consistent patterns - **no changes needed** to existing code:

### Actuator Example
```csharp
public sealed class ShoulderActuator(ComponentData? componentData = null) 
    : Component(Definition, componentData)
{
    public static readonly ActuatorDefinition Definition = new(
        "Shoulder",
        MakaMekComponent.Shoulder);
    
    public static readonly int[] DefaultMountSlots = [0];
}
```

### Internal Component Example
```csharp
public sealed class Gyro(ComponentData? componentData = null) 
    : Component(Definition, componentData)
{
    public static readonly InternalDefinition Definition = new(
        "Gyro",
        2, // 2 health points
        MakaMekComponent.Gyro,
        4); // 4 slots
    
    public static readonly int[] DefaultMountSlots = [3, 4, 5, 6];
}
```

### Weapon Example (with Ammo)
```csharp
public sealed class MachineGun(ComponentData? componentData = null) 
    : Weapon(Definition, componentData)
{
    public static readonly WeaponDefinition Definition = new(
        Name: "Machine Gun",
        ElementaryDamage: 2,
        Heat: 0,
        MinimumRange: 0,
        ShortRange: 1,
        MediumRange: 2,
        LongRange: 3,
        Type: WeaponType.Ballistic,
        BattleValue: 5,
        FullAmmoRounds: 200,
        WeaponComponentType: MakaMekComponent.MachineGun,
        AmmoComponentType: MakaMekComponent.ISAmmoMG);  // Links to ammo
}
```

### Energy Weapon Example (no Ammo)
```csharp
public sealed class SmallLaser(ComponentData? componentData = null) 
    : Weapon(Definition, componentData)
{
    public static readonly WeaponDefinition Definition = new(
        Name: "Small Laser",
        ElementaryDamage: 3,
        Heat: 1,
        MinimumRange: 0,
        ShortRange: 1,
        MediumRange: 2,
        LongRange: 3,
        Type: WeaponType.Energy,
        BattleValue: 9,
        WeaponComponentType: MakaMekComponent.SmallLaser);
        // No AmmoComponentType - energy weapons don't need ammo
}
```

### Special Case: Engine
```csharp
public class Engine : Component
{
    public int Rating { get; }
    public EngineType Type { get; }

    // Engine requires ComponentData with EngineStateData
    public Engine(ComponentData componentData)
        : base(CreateEngineDefinition(componentData.SpecificData), componentData)
    {
        var engineState = (EngineStateData)componentData.SpecificData!;
        Name = $"{Type} Engine {engineState.Rating}";
        Rating = engineState.Rating;
        Type = engineState.Type;
        NumberOfHeatSinks = GetNumberOfHeatSinks(Rating);
    }

    // Dynamic definition creation
    public static EngineDefinition CreateEngineDefinition(ComponentSpecificData? engineState)
    {
        return engineState is not EngineStateData engineStateData 
            ? throw new ArgumentException("Invalid component data for engine") 
            : new EngineDefinition(engineStateData.Type, engineStateData.Rating);
    }
    
    // ... rest of implementation
}
```

## Generated Code Example

The source generator will produce a file like this (showing full example with all 48+ components):

```csharp
// <auto-generated/>
// This file is automatically generated by ComponentProviderGenerator
// Do not modify this file manually - changes will be overwritten

using System;
using System.Collections.Generic;
using Sanet.MakaMek.Core.Data.Units.Components;
using Sanet.MakaMek.Core.Models.Units.Components;
using Sanet.MakaMek.Core.Models.Units.Components.Engines;
using Sanet.MakaMek.Core.Models.Units.Components.Internal;
using Sanet.MakaMek.Core.Models.Units.Components.Internal.Actuators;
using Sanet.MakaMek.Core.Models.Units.Components.Weapons;
using Sanet.MakaMek.Core.Models.Units.Components.Weapons.Ballistic;
using Sanet.MakaMek.Core.Models.Units.Components.Weapons.Energy;
using Sanet.MakaMek.Core.Models.Units.Components.Weapons.Melee;
using Sanet.MakaMek.Core.Models.Units.Components.Weapons.Missile;

namespace Sanet.MakaMek.Core.Models.Game.Rules
{
    /// <summary>
    /// Auto-generated component mappings for ClassicBattletechComponentProvider
    /// Generated by ComponentProviderGenerator source generator
    /// Total components: 48 (36 regular + 12 ammo)
    /// </summary>
    public partial class ClassicBattletechComponentProvider
    {
        /// <summary>
        /// Initializes component definitions dictionary with auto-discovered mappings
        /// </summary>
        /// <param name="definitions">Dictionary to populate with component definitions</param>
        partial void InitializeGeneratedDefinitions(
            Dictionary<MakaMekComponent, ComponentDefinition> definitions)
        {
            // ========================================
            // Actuators (8 components)
            // ========================================
            definitions[MakaMekComponent.Shoulder] = ShoulderActuator.Definition;
            definitions[MakaMekComponent.UpperArmActuator] = UpperArmActuator.Definition;
            definitions[MakaMekComponent.LowerArmActuator] = LowerArmActuator.Definition;
            definitions[MakaMekComponent.HandActuator] = HandActuator.Definition;
            definitions[MakaMekComponent.Hip] = HipActuator.Definition;
            definitions[MakaMekComponent.UpperLegActuator] = UpperLegActuator.Definition;
            definitions[MakaMekComponent.LowerLegActuator] = LowerLegActuator.Definition;
            definitions[MakaMekComponent.FootActuator] = FootActuator.Definition;

            // ========================================
            // Internal Components (4 components)
            // ========================================
            definitions[MakaMekComponent.Gyro] = Gyro.Definition;
            definitions[MakaMekComponent.LifeSupport] = LifeSupport.Definition;
            definitions[MakaMekComponent.Sensors] = Sensors.Definition;
            definitions[MakaMekComponent.Cockpit] = Cockpit.Definition;

            // ========================================
            // Equipment (3 components)
            // ========================================
            definitions[MakaMekComponent.HeatSink] = HeatSink.Definition;
            definitions[MakaMekComponent.JumpJet] = JumpJets.Definition;
            definitions[MakaMekComponent.Masc] = Masc.Definition;

            // ========================================
            // Energy Weapons (5 components)
            // ========================================
            definitions[MakaMekComponent.SmallLaser] = SmallLaser.Definition;
            definitions[MakaMekComponent.MediumLaser] = MediumLaser.Definition;
            definitions[MakaMekComponent.LargeLaser] = LargeLaser.Definition;
            definitions[MakaMekComponent.PPC] = Ppc.Definition;
            definitions[MakaMekComponent.Flamer] = Flamer.Definition;

            // ========================================
            // Ballistic Weapons (5 components)
            // ========================================
            definitions[MakaMekComponent.MachineGun] = MachineGun.Definition;
            definitions[MakaMekComponent.AC2] = Ac2.Definition;
            definitions[MakaMekComponent.AC5] = Ac5.Definition;
            definitions[MakaMekComponent.AC10] = Ac10.Definition;
            definitions[MakaMekComponent.AC20] = Ac20.Definition;

            // ========================================
            // Missile Weapons (7 components)
            // ========================================
            definitions[MakaMekComponent.LRM5] = Lrm5.Definition;
            definitions[MakaMekComponent.LRM10] = Lrm10.Definition;
            definitions[MakaMekComponent.LRM15] = Lrm15.Definition;
            definitions[MakaMekComponent.LRM20] = Lrm20.Definition;
            definitions[MakaMekComponent.SRM2] = Srm2.Definition;
            definitions[MakaMekComponent.SRM4] = Srm4.Definition;
            definitions[MakaMekComponent.SRM6] = Srm6.Definition;

            // ========================================
            // Melee Weapons (1 component)
            // ========================================
            definitions[MakaMekComponent.Hatchet] = Hatchet.Definition;

            // ========================================
            // Ammunition (12 components)
            // Generated from WeaponDefinition.AmmoComponentType
            // ========================================
            definitions[MakaMekComponent.ISAmmoMG] = Ammo.CreateAmmoDefinition(MachineGun.Definition);
            definitions[MakaMekComponent.ISAmmoAC2] = Ammo.CreateAmmoDefinition(Ac2.Definition);
            definitions[MakaMekComponent.ISAmmoAC5] = Ammo.CreateAmmoDefinition(Ac5.Definition);
            definitions[MakaMekComponent.ISAmmoAC10] = Ammo.CreateAmmoDefinition(Ac10.Definition);
            definitions[MakaMekComponent.ISAmmoAC20] = Ammo.CreateAmmoDefinition(Ac20.Definition);
            definitions[MakaMekComponent.ISAmmoLRM5] = Ammo.CreateAmmoDefinition(Lrm5.Definition);
            definitions[MakaMekComponent.ISAmmoLRM10] = Ammo.CreateAmmoDefinition(Lrm10.Definition);
            definitions[MakaMekComponent.ISAmmoLRM15] = Ammo.CreateAmmoDefinition(Lrm15.Definition);
            definitions[MakaMekComponent.ISAmmoLRM20] = Ammo.CreateAmmoDefinition(Lrm20.Definition);
            definitions[MakaMekComponent.ISAmmoSRM2] = Ammo.CreateAmmoDefinition(Srm2.Definition);
            definitions[MakaMekComponent.ISAmmoSRM4] = Ammo.CreateAmmoDefinition(Srm4.Definition);
            definitions[MakaMekComponent.ISAmmoSRM6] = Ammo.CreateAmmoDefinition(Srm6.Definition);

            // Note: Engine is excluded - handled manually in GetDefinition() due to dynamic definition
        }

        /// <summary>
        /// Initializes component factories dictionary with auto-discovered constructors
        /// </summary>
        /// <param name="factories">Dictionary to populate with component factory functions</param>
        partial void InitializeGeneratedFactories(
            Dictionary<MakaMekComponent, Func<ComponentData?, Component?>> factories)
        {
            // ========================================
            // Actuators (8 components)
            // ========================================
            factories[MakaMekComponent.Shoulder] = data => new ShoulderActuator(data);
            factories[MakaMekComponent.UpperArmActuator] = data => new UpperArmActuator(data);
            factories[MakaMekComponent.LowerArmActuator] = data => new LowerArmActuator(data);
            factories[MakaMekComponent.HandActuator] = data => new HandActuator(data);
            factories[MakaMekComponent.Hip] = data => new HipActuator(data);
            factories[MakaMekComponent.UpperLegActuator] = data => new UpperLegActuator(data);
            factories[MakaMekComponent.LowerLegActuator] = data => new LowerLegActuator(data);
            factories[MakaMekComponent.FootActuator] = data => new FootActuator(data);

            // ========================================
            // Internal Components (4 components)
            // ========================================
            factories[MakaMekComponent.Gyro] = data => new Gyro(data);
            factories[MakaMekComponent.LifeSupport] = data => new LifeSupport(data);
            factories[MakaMekComponent.Sensors] = data => new Sensors(data);
            factories[MakaMekComponent.Cockpit] = data => new Cockpit(data);

            // ========================================
            // Equipment (3 components)
            // ========================================
            factories[MakaMekComponent.HeatSink] = data => new HeatSink(data);
            factories[MakaMekComponent.JumpJet] = data => new JumpJets(data);
            factories[MakaMekComponent.Masc] = data => new Masc(data);

            // ========================================
            // Engines (1 component - special case)
            // Requires EngineStateData in ComponentData.SpecificData
            // ========================================
            factories[MakaMekComponent.Engine] = data => 
                data?.SpecificData is EngineStateData ? new Engine(data) : null;

            // ========================================
            // Energy Weapons (5 components)
            // ========================================
            factories[MakaMekComponent.SmallLaser] = data => new SmallLaser(data);
            factories[MakaMekComponent.MediumLaser] = data => new MediumLaser(data);
            factories[MakaMekComponent.LargeLaser] = data => new LargeLaser(data);
            factories[MakaMekComponent.PPC] = data => new Ppc(data);
            factories[MakaMekComponent.Flamer] = data => new Flamer(data);

            // ========================================
            // Ballistic Weapons (5 components)
            // ========================================
            factories[MakaMekComponent.MachineGun] = data => new MachineGun(data);
            factories[MakaMekComponent.AC2] = data => new Ac2(data);
            factories[MakaMekComponent.AC5] = data => new Ac5(data);
            factories[MakaMekComponent.AC10] = data => new Ac10(data);
            factories[MakaMekComponent.AC20] = data => new Ac20(data);

            // ========================================
            // Missile Weapons (7 components)
            // ========================================
            factories[MakaMekComponent.LRM5] = data => new Lrm5(data);
            factories[MakaMekComponent.LRM10] = data => new Lrm10(data);
            factories[MakaMekComponent.LRM15] = data => new Lrm15(data);
            factories[MakaMekComponent.LRM20] = data => new Lrm20(data);
            factories[MakaMekComponent.SRM2] = data => new Srm2(data);
            factories[MakaMekComponent.SRM4] = data => new Srm4(data);
            factories[MakaMekComponent.SRM6] = data => new Srm6(data);

            // ========================================
            // Melee Weapons (1 component)
            // ========================================
            factories[MakaMekComponent.Hatchet] = data => new Hatchet(data);

            // ========================================
            // Ammunition (12 components)
            // Generated from WeaponDefinition.AmmoComponentType
            // Each ammo type references its weapon's Definition
            // ========================================
            factories[MakaMekComponent.ISAmmoMG] = data => new Ammo(MachineGun.Definition, data);
            factories[MakaMekComponent.ISAmmoAC2] = data => new Ammo(Ac2.Definition, data);
            factories[MakaMekComponent.ISAmmoAC5] = data => new Ammo(Ac5.Definition, data);
            factories[MakaMekComponent.ISAmmoAC10] = data => new Ammo(Ac10.Definition, data);
            factories[MakaMekComponent.ISAmmoAC20] = data => new Ammo(Ac20.Definition, data);
            factories[MakaMekComponent.ISAmmoLRM5] = data => new Ammo(Lrm5.Definition, data);
            factories[MakaMekComponent.ISAmmoLRM10] = data => new Ammo(Lrm10.Definition, data);
            factories[MakaMekComponent.ISAmmoLRM15] = data => new Ammo(Lrm15.Definition, data);
            factories[MakaMekComponent.ISAmmoLRM20] = data => new Ammo(Lrm20.Definition, data);
            factories[MakaMekComponent.ISAmmoSRM2] = data => new Ammo(Srm2.Definition, data);
            factories[MakaMekComponent.ISAmmoSRM4] = data => new Ammo(Srm4.Definition, data);
            factories[MakaMekComponent.ISAmmoSRM6] = data => new Ammo(Srm6.Definition, data);
        }
    }
}
```

## Modified Provider Class

The `ClassicBattletechComponentProvider` becomes much simpler:

```csharp
using Sanet.MakaMek.Core.Data.Units.Components;
using Sanet.MakaMek.Core.Models.Units.Components;
using Sanet.MakaMek.Core.Models.Units.Components.Engines;

namespace Sanet.MakaMek.Core.Models.Game.Rules;

/// <summary>
/// Registry containing all component definitions and factory methods
/// Component mappings are auto-generated by ComponentProviderGenerator
/// </summary>
public partial class ClassicBattletechComponentProvider : IComponentProvider
{
    private readonly Dictionary<MakaMekComponent, ComponentDefinition> _definitions;
    private readonly Dictionary<MakaMekComponent, Func<ComponentData?, Component?>> _factories;

    public ClassicBattletechComponentProvider()
    {
        _definitions = new Dictionary<MakaMekComponent, ComponentDefinition>();
        _factories = new Dictionary<MakaMekComponent, Func<ComponentData?, Component?>>();
        
        // Populated by source-generated partial methods
        InitializeGeneratedDefinitions(_definitions);
        InitializeGeneratedFactories(_factories);
    }

    /// <summary>
    /// Partial method implemented by source generator to populate definitions
    /// </summary>
    partial void InitializeGeneratedDefinitions(
        Dictionary<MakaMekComponent, ComponentDefinition> definitions);

    /// <summary>
    /// Partial method implemented by source generator to populate factories
    /// </summary>
    partial void InitializeGeneratedFactories(
        Dictionary<MakaMekComponent, Func<ComponentData?, Component?>> factories);

    public ComponentDefinition? GetDefinition(
        MakaMekComponent componentType, 
        ComponentSpecificData? specificData = null)
    {
        // Special case: Engine has dynamic definition based on state
        if (componentType == MakaMekComponent.Engine && specificData is EngineStateData engineState)
        {
            return Engine.CreateEngineDefinition(engineState);
        }
        
        // All other components use generated mappings
        return _definitions.GetValueOrDefault(componentType);
    }

    public Component? CreateComponent(
        MakaMekComponent componentType, 
        ComponentData? componentData = null)
    {
        return _factories.TryGetValue(componentType, out var factory) 
            ? factory(componentData) 
            : null;
    }
}
```

**Key changes:**
- Removed 150+ lines of manual dictionary initialization
- Added two partial method declarations
- Kept Engine special case in `GetDefinition()`
- Much cleaner and easier to understand

## Developer Workflow

### Adding a New Component

To add a new component (e.g., Gauss Rifle), developers only need to:

**Step 1:** Add enum value to `MakaMekComponent.cs`
```csharp
public enum MakaMekComponent
{
    // ... existing values ...
    Gauss,          // New weapon
    ISAmmoGauss     // New ammo
}
```

**Step 2:** Create component class following the pattern
```csharp
namespace Sanet.MakaMek.Core.Models.Units.Components.Weapons.Ballistic;

public sealed class GaussRifle(ComponentData? componentData = null) 
    : Weapon(Definition, componentData)
{
    public static readonly WeaponDefinition Definition = new(
        Name: "Gauss Rifle",
        ElementaryDamage: 15,
        Heat: 1,
        MinimumRange: 2,
        ShortRange: 7,
        MediumRange: 15,
        LongRange: 22,
        Type: WeaponType.Ballistic,
        BattleValue: 320,
        Size: 7,
        FullAmmoRounds: 8,
        WeaponComponentType: MakaMekComponent.Gauss,
        AmmoComponentType: MakaMekComponent.ISAmmoGauss);
}
```

**Step 3:** Build the project

The source generator automatically:
- ✅ Discovers the new `GaussRifle` class
- ✅ Extracts the `Definition` property
- ✅ Detects the `AmmoComponentType`
- ✅ Generates mappings for both weapon and ammo
- ✅ No manual updates to `ClassicBattletechComponentProvider` needed!

**Generated code includes:**
```csharp
// In InitializeGeneratedDefinitions:
definitions[MakaMekComponent.Gauss] = GaussRifle.Definition;
definitions[MakaMekComponent.ISAmmoGauss] = Ammo.CreateAmmoDefinition(GaussRifle.Definition);

// In InitializeGeneratedFactories:
factories[MakaMekComponent.Gauss] = data => new GaussRifle(data);
factories[MakaMekComponent.ISAmmoGauss] = data => new Ammo(GaussRifle.Definition, data);
```

## Generator Algorithm

High-level pseudocode for the source generator:

```
INITIALIZE:
    component_mappings = []
    ammo_mappings = []
    weapon_definitions = {}

PHASE 1: Discover Component Classes
    FOR EACH class in compilation:
        IF class inherits from Component AND is not abstract:
            
            // Find static Definition property
            definition_property = class.GetStaticProperty("Definition")
            IF definition_property is null:
                CONTINUE  // Skip this class
            
            definition_type = definition_property.Type
            component_type = ExtractComponentType(definition_property)
            
            // Store component mapping
            component_mappings.Add({
                ComponentType: component_type,
                ClassName: class.Name,
                FullNamespace: class.Namespace,
                DefinitionType: definition_type,
                IsEngine: class.Name == "Engine"
            })
            
            // Track weapon definitions for ammo generation
            IF definition_type is WeaponDefinition:
                weapon_definitions[class.Name] = definition_property

PHASE 2: Discover Ammo Types
    FOR EACH (weapon_name, weapon_def) in weapon_definitions:
        ammo_type = weapon_def.AmmoComponentType
        IF ammo_type is not null:
            ammo_mappings.Add({
                AmmoComponentType: ammo_type,
                WeaponClassName: weapon_name
            })

PHASE 3: Generate Definitions Method
    EMIT: "partial void InitializeGeneratedDefinitions("
    EMIT: "    Dictionary<MakaMekComponent, ComponentDefinition> definitions)"
    EMIT: "{"
    
    // Regular components (except Engine)
    FOR EACH mapping in component_mappings:
        IF NOT mapping.IsEngine:
            EMIT: "    definitions[MakaMekComponent.{mapping.ComponentType}] = {mapping.ClassName}.Definition;"
    
    // Ammo components
    FOR EACH ammo in ammo_mappings:
        EMIT: "    definitions[MakaMekComponent.{ammo.AmmoComponentType}] = "
        EMIT: "        Ammo.CreateAmmoDefinition({ammo.WeaponClassName}.Definition);"
    
    EMIT: "}"

PHASE 4: Generate Factories Method
    EMIT: "partial void InitializeGeneratedFactories("
    EMIT: "    Dictionary<MakaMekComponent, Func<ComponentData?, Component?>> factories)"
    EMIT: "{"
    
    // All components (including Engine with special handling)
    FOR EACH mapping in component_mappings:
        IF mapping.IsEngine:
            EMIT: "    factories[MakaMekComponent.Engine] = data => "
            EMIT: "        data?.SpecificData is EngineStateData ? new Engine(data) : null;"
        ELSE:
            EMIT: "    factories[MakaMekComponent.{mapping.ComponentType}] = "
            EMIT: "        data => new {mapping.ClassName}(data);"
    
    // Ammo components
    FOR EACH ammo in ammo_mappings:
        EMIT: "    factories[MakaMekComponent.{ammo.AmmoComponentType}] = "
        EMIT: "        data => new Ammo({ammo.WeaponClassName}.Definition, data);"
    
    EMIT: "}"

PHASE 5: Add Using Statements
    namespaces = DISTINCT(component_mappings.Select(m => m.FullNamespace))
    FOR EACH namespace in namespaces:
        EMIT: "using {namespace};"
```

**Key Implementation Details:**

1. **Incremental Generation**: Only regenerate when component classes change
2. **Error Handling**: Report diagnostics for classes missing Definition property
3. **Validation**: Verify constructor signature matches expected pattern
4. **Ordering**: Sort components by category for readable generated code
5. **Comments**: Add section headers and counts for maintainability

